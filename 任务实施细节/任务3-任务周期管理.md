# 任务3：任务周期管理

## 需求描述
分离任务新循环设置，拆分为小组件。修复点击完成任务后没有正常新建下一个周期任务的问题。对于完成的任务，以完成日期为开始时间加上循环天数；对于逾期任务，以截止日期为开始时间加上循环天数。同时添加完成和逾期任务的统计记录。

## 技术分析
当前任务周期管理的功能分散在多个文件中，需要集中处理并修复现有的任务循环生成逻辑。同时需要增强统计功能，追踪任务完成和逾期情况。

## 实施计划

### 1. 创建任务周期设置组件
- 创建 `components/widgets/TaskCycleWidget.tsx` 组件
- 将任务周期相关的设置逻辑从现有组件中提取
- 设计清晰的接口，支持不同的周期创建规则

### 2. 修复任务完成生成新周期逻辑
- 分析当前任务完成后的周期生成逻辑
- 修复完成任务后不生成新周期的问题
- 实现基于完成日期的新周期生成规则

### 3. 实现不同任务状态的周期生成规则
- 对于完成的任务：以完成日期 + 循环天数生成下一周期
- 对于逾期任务：以截止日期 + 循环天数生成下一周期
- 确保所有场景下都能正确生成新周期

### 4. 增强任务统计功能
- 为完成的任务添加记录到统计表
- 为逾期任务添加记录到逾期统计表
- 扩展统计视图，显示完成率和逾期率

### 5. 任务详情增强
- 更新任务详情页面，添加历史周期信息
- 显示任务的完成历史和逾期历史
- 提供周期趋势分析（如完成时间趋势）

### 6. 更新数据模型
- 修改 `TaskCycle` 模型，添加更多状态和元数据
- 扩展 `TaskHistory` 模型，支持更详细的记录
- 确保数据模型支持新的周期管理功能

## 相关文件
- `models/Task.ts` - 任务模型
- `models/TaskCycle.ts` - 任务周期模型
- `models/TaskHistory.ts` - 任务历史记录模型
- `services/taskService.ts` - 任务服务
- 待创建: `components/widgets/TaskCycleWidget.tsx` - 任务周期组件
- `components/TaskDetail.tsx` - 任务详情组件
- `app/statistics.tsx` - 统计页面

## 注意事项
- 确保修复不会影响现有用户的任务数据
- 周期生成规则要考虑各种边界情况（如日期跨月、农历日期等）
- 统计功能要考虑性能影响，避免数据量大时的卡顿
- 提供数据迁移机制，确保旧数据能够适配新的周期管理逻辑
- 考虑用户体验，让用户容易理解不同情况下的周期生成规则 