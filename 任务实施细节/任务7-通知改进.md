# 任务7：通知改进

## 需求描述
添加通知栏常驻功能，优化通知触发，完善任务完成记录，并实现当日任务概览（以每天早上6点为起点，到第二天早上6点为一天的结束）。

## 技术分析
当前的通知系统是基本的推送通知，需要增强其功能并提高可靠性。在Android上需要实现前台服务来支持常驻通知，而对于任务统计需要重新定义"一天"的概念，不再是传统的0点-24点。

## 实施计划

### 1. 实现通知栏常驻功能
- 创建 `services/foregroundService.ts` 服务
- 为Android实现前台服务：
  ```typescript
  import * as Notifications from 'expo-notifications';
  import * as TaskManager from 'expo-task-manager';
  
  const FOREGROUND_SERVICE_TASK_NAME = 'NEVERMISS_FOREGROUND_SERVICE';
  
  // 定义前台服务任务
  TaskManager.defineTask(FOREGROUND_SERVICE_TASK_NAME, () => {
    // 保持服务运行的逻辑
    return TaskManager.BackgroundFetch.Result.NewData;
  });
  
  export async function startForegroundService() {
    // 实现启动前台服务的逻辑
  }
  ```
- 在iOS上使用可用的最佳替代方案
- 添加设置选项以启用/禁用常驻通知

### 2. 重新定义"一天"的概念
- 创建 `utils/dayBoundary.ts` 工具模块：
  ```typescript
  // 定义一天的起始时间为早上6点
  export const DAY_START_HOUR = 6;
  
  // 获取当前"日"的开始时间
  export function getCurrentDayStart(): Date {
    const now = new Date();
    const currentHour = now.getHours();
    
    // 如果当前时间早于早上6点，则返回昨天的早上6点
    if (currentHour < DAY_START_HOUR) {
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      yesterday.setHours(DAY_START_HOUR, 0, 0, 0);
      return yesterday;
    }
    
    // 否则返回今天的早上6点
    const today = new Date(now);
    today.setHours(DAY_START_HOUR, 0, 0, 0);
    return today;
  }
  
  // 获取当前"日"的结束时间（明天早上6点）
  export function getCurrentDayEnd(): Date {
    const dayStart = getCurrentDayStart();
    const dayEnd = new Date(dayStart);
    dayEnd.setDate(dayEnd.getDate() + 1);
    return dayEnd;
  }
  ```
- 更新任务筛选和统计功能，使用新的日边界定义

### 3. 优化通知触发逻辑
- 重构 `services/notificationService.ts`
- 添加通知可靠性保障机制：
  - 实现通知发送确认
  - 添加通知重试机制
  - 处理设备重启后的通知恢复
- 添加通知分组功能，按任务类型或时间段分组
- 优化通知内容，包含更多任务上下文

### 4. 实现当日任务概览
- 创建 `components/widgets/DailyTaskSummary.tsx` 组件
- 添加早晨概览通知，包括：
  - 今日待完成任务数量
  - 重要/紧急任务提醒
  - 昨日未完成任务汇总
- 创建日结束时的任务完成情况通知

### 5. 完善任务完成记录
- 增强 `models/TaskHistory.ts` 记录更详细的完成信息
- 在任务完成时捕获更多上下文数据，如：
  - 精确的完成时间戳
  - 完成时的位置（如果有权限）
  - 与预计时间的偏差
- 实现完成记录的可视化统计

### 6. 添加通知设置选项
- 更新 `app/settings.tsx` 设置页面
- 添加以下通知设置：
  - 常驻通知开关
  - 任务概览通知时间
  - 通知声音选择
  - 通知优先级设置
  - 免打扰时段设置

### 7. 实现通知交互增强
- 添加直接从通知完成任务的功能
- 添加通知推迟选项（稍后提醒）
- 实现通知操作记录，跟踪用户与通知的交互

## 相关文件
- `services/notificationService.ts` - 通知服务
- 待创建: `services/foregroundService.ts` - 前台服务实现
- 待创建: `utils/dayBoundary.ts` - 日边界定义工具
- 待创建: `components/widgets/DailyTaskSummary.tsx` - 日任务概览组件
- `models/TaskHistory.ts` - 任务历史记录模型
- `app/settings.tsx` - 设置页面

## 注意事项
- Android和iOS通知机制有差异，需要针对性实现
- 常驻通知可能增加电池消耗，应提供省电选项
- 新的日边界定义（早6点）需要在所有相关功能中保持一致
- 通知设置应考虑用户隐私和使用习惯
- 通知交互应简洁直观，避免操作复杂
- 任务完成记录要考虑存储空间增长，可能需要定期清理策略
- 确保在跨日期边界时（如早上5:59到6:01）的数据一致性 